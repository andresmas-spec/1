<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Guiones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .shadow-custom {
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 0 15px 5px rgba(99, 102, 241, 0.2);
        }
        .voice-active {
            color: #4f46e5 !important;
        }
        .chat-user-bubble {
            background-color: #e0f2fe;
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
            max-width: 85%;
            padding: 0.75rem 1rem;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-gemini-bubble {
            background-color: #f3f4f6;
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
            max-width: 85%;
            padding: 0.75rem 1rem;
            align-self: flex-start;
        }
        .ai-message {
            background-color: #e2e8f0;
            padding: 1rem;
            border-left: 4px solid #4f46e5;
            border-radius: 0.5rem;
            color: #1f2937;
        }
        @media (min-width: 640px) {
            .sm-grid-cols-2 {
                grid-template-columns: 1fr 1fr;
            }
        }
        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }
        .video-preview-icon {
            font-size: 2.5rem;
            color: #4f46e5;
        }
        .script-card-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-gray-100 min-h-screen flex items-center justify-center">

    <div id="loading-spinner-overlay" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
        <p id="loading-text" class="mt-2 text-gray-500">Cargando guiones...</p>
    </div>

    <div id="app-content" class="bg-white rounded-xl shadow-2xl p-6 sm:p-10 w-full max-w-4xl border-t-8 border-indigo-600 hidden">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Gestor de Guiones</h1>
            <p class="text-gray-600">Guarda tus guiones de forma local con la ayuda de la IA.</p>
        </header>

        <div id="status-message" class="bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg p-4 hidden mb-6" role="alert">
            <p class="font-bold">Error del Sistema</p>
            <p id="status-text"></p>
        </div>
        <div id="success-message" class="bg-green-100 text-green-700 border-l-4 border-green-500 rounded-lg p-4 hidden mb-6" role="alert">
            <p class="font-bold">¬°√âxito!</p>
            <p id="success-text"></p>
        </div>

        <div class="mb-8">
            <form id="script-form" class="bg-gray-50 p-6 rounded-xl shadow-inner">
                <input type="hidden" id="script-id">
                <input type="text" id="script-title" placeholder="T√≠tulo del gui√≥n" required class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <select id="script-category" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Selecciona una categor√≠a</option>
                    <option value="ficcion">Ficci√≥n</option>
                    <option value="no-ficcion">No Ficci√≥n</option>
                    <option value="poesia">Poes√≠a</option>
                    <option value="guion-cinematografico">Guion Cinematogr√°fico</option>
                    <option value="guion-teatral">Guion Teatral</option>
                    <option value="podcast">Podcast</option>
                    <option value="otro">Otro</option>
                </select>
                <div class="relative mb-4">
                    <textarea id="script-content" placeholder="Escribe tu gui√≥n aqu√≠..." rows="8" required class="w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    <button type="button" id="voice-to-text-btn" class="absolute top-2 right-2 text-gray-400 hover:text-indigo-600 transition-colors duration-200 focus:outline-none">
                        <i class="fas fa-microphone text-xl"></i>
                    </button>
                </div>
                <div id="voice-status" class="text-center text-gray-500 text-sm mb-4 hidden"></div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Ubicaci√≥n (opcional):</label>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center">
                        <button type="button" id="get-location-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors duration-300 flex items-center justify-center w-full sm:w-auto">
                            <i class="fas fa-map-marker-alt mr-2"></i>Ubicaci√≥n Actual
                        </button>
                        <div class="flex w-full space-x-2 mt-2 sm:mt-0">
                            <input type="text" id="script-address" placeholder="O escribe una direcci√≥n..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" id="search-address-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300 flex-shrink-0">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <span id="location-status" class="block text-sm text-gray-600 mt-2"></span>
                    <input type="hidden" id="script-location-coords">
                    <input type="hidden" id="script-location-address">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Archivos Multimedia (opcional):</label>
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        <label for="image-upload" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors duration-300 flex items-center">
                            <i class="fas fa-image mr-2"></i> Subir Fotos
                        </label>
                        <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
                        <label for="video-upload" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors duration-300 flex items-center">
                            <i class="fas fa-video mr-2"></i> Subir Video
                        </label>
                        <input type="file" id="video-upload" accept="video/*" class="hidden">
                    </div>
                    <div id="image-previews" class="flex flex-wrap gap-2 mb-2"></div>
                    <span id="file-status" class="block text-sm text-gray-600"></span>
                    <input type="hidden" id="script-images">
                    <input type="hidden" id="script-video">
                </div>
                
                <button type="submit" id="save-script-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors duration-300">Guardar Gui√≥n</button>
                <button type="button" id="cancel-edit-btn" class="w-full mt-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition-colors duration-300 hidden">Cancelar Edici√≥n</button>
            </form>
        </div>

        <div class="mb-8 p-6 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">An√°lisis de la Colecci√≥n</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <button id="summarize-all-btn" class="bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-600 transition text-center">Resumir Todos ‚ú®</button>
                <button id="chat-all-btn" class="bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-600 transition text-center">Chat sobre la Colecci√≥n üí¨</button>
                <button id="search-all-btn" class="bg-orange-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-orange-600 transition text-center">Buscar Informaci√≥n üîç</button>
            </div>
        </div>

        <div class="mb-4 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-4">
            <h2 class="text-2xl font-bold text-gray-800">Mis Guiones</h2>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <button id="export-all-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2">
                    <i class="fas fa-file-export"></i>
                    <span>Exportar Todos</span>
                </button>
                <div class="relative w-full sm:w-auto">
                    <label for="import-file" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 cursor-pointer flex items-center justify-center space-x-2">
                        <i class="fas fa-file-import"></i>
                        <span>Importar</span>
                    </label>
                    <input type="file" id="import-file" class="hidden" accept=".json">
                </div>
            </div>
        </div>

        <div class="mb-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <input type="text" id="main-search-input" placeholder="Buscar por t√≠tulo, contenido o categor√≠a..." class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <select id="filter-category" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">Todas las categor√≠as</option>
                <option value="ficcion">Ficci√≥n</option>
                <option value="no-ficcion">No Ficci√≥n</option>
                <option value="poesia">Poes√≠a</option>
                <option value="guion-cinematografico">Guion Cinematogr√°fico</option>
                <option value="guion-teatral">Guion Teatral</option>
                <option value="podcast">Podcast</option>
                <option value="otro">Otro</option>
            </select>
            <select id="sort-menu" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="recent">M√°s recientes</option>
                <option value="oldest">M√°s antiguos</option>
            </select>
        </div>

        <div id="scripts-list" class="space-y-4">
        </div>
    </div>

    <div id="script-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-3xl shadow-custom w-full max-w-2xl max-h-[95vh] flex flex-col overflow-y-auto z-50">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900 truncate"></h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-800 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <textarea id="modal-content" rows="10" class="w-full p-4 rounded-lg bg-gray-100 border-2 border-gray-200 overflow-y-auto max-h-[60vh] resize-none flex-grow" readonly></textarea>

            <div id="modal-media-container" class="mt-4 hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Archivos Multimedia</h3>
                <div id="modal-images" class="flex flex-wrap gap-2 mb-4"></div>
                <div id="modal-video-container" class="w-full hidden">
                    <video id="modal-video" controls class="w-full rounded-lg"></video>
                </div>
            </div>
            <div class="mt-4" id="location-display-container">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Ubicaci√≥n del Guion</h3>
                <p id="modal-location-text" class="text-gray-700 mb-2"></p>
                <div id="map-container" class="w-full h-64 rounded-lg bg-gray-200"></div>
            </div>
            
            <div class="mt-4 flex flex-wrap gap-2 justify-end modal-action-buttons">
                <button class="export-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Exportar</button>
                <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Editar</button>
                <button class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Eliminar</button>
                <button class="chat-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Chat con IA</button>
            </div>
        </div>
    </div>

    <div id="global-ai-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-3xl shadow-custom w-full max-w-2xl max-h-[95vh] flex flex-col z-50">
            <div class="flex justify-between items-center mb-4">
                <h2 id="global-ai-modal-title" class="text-2xl font-bold text-gray-900 truncate">An√°lisis de la Colecci√≥n</h2>
                <button id="close-global-ai-modal" class="text-gray-500 hover:text-gray-800 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="flex-grow flex flex-col">
                <div id="global-summary-output" class="p-4 rounded-lg ai-message hidden overflow-y-auto max-h-[60vh] mb-4"></div>
                <div id="global-chat-container" class="flex-grow flex flex-col hidden">
                    <div id="global-chat-messages" class="flex-grow flex flex-col p-4 bg-gray-100 rounded-lg mb-2 overflow-y-auto max-h-[60vh] space-y-4"></div>
                    <div class="flex">
                        <input type="text" id="global-chat-input" placeholder="Pregunta sobre la colecci√≥n de guiones..." class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="global-chat-send" class="ml-2 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition">Enviar</button>
                    </div>
                </div>
                
                <div id="global-search-container" class="flex-grow flex flex-col hidden">
                    <div id="global-search-results" class="flex-grow p-4 bg-gray-100 rounded-lg mb-2 overflow-y-auto max-h-[60vh] space-y-4"></div>
                    <div class="flex">
                        <input type="text" id="global-search-input" placeholder="Busca informaci√≥n en la web..." class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="button" id="global-search-send-btn" class="ml-2 bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">Buscar</button>
                    </div>
                </div>

                <div id="loading-spinner-modal" class="text-center text-gray-500 hidden mt-4">
                    <i class="fas fa-spinner fa-spin text-2xl"></i>
                    <p class="mt-2 text-sm">Generando...</p>
                </div>

                <div id="modal-status-message" class="bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg p-4 hidden mt-4" role="alert">
                    <p id="modal-status-text"></p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="individual-chat-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-3xl shadow-custom w-full max-w-2xl max-h-[95vh] flex flex-col z-50">
            <div class="flex justify-between items-center mb-4">
                <h2 id="individual-chat-title" class="text-2xl font-bold text-gray-900 truncate">Chat de Guion</h2>
                <button id="close-individual-chat" class="text-gray-500 hover:text-gray-800 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="flex-grow flex flex-col">
                <div id="individual-chat-messages" class="flex-grow flex flex-col p-4 bg-gray-100 rounded-lg mb-2 overflow-y-auto max-h-[60vh] space-y-4"></div>
                <div class="flex">
                    <input type="text" id="individual-chat-input" placeholder="Pregunta sobre este guion..." class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="individual-chat-send" class="ml-2 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // --- C√ìDIGO A REVISAR ---
        // Reemplaza estas claves con tus propias claves API para que las funciones de IA funcionen correctamente.
        // Google Maps API Key: https://developers.google.com/maps/documentation/javascript/get-api-key
        const GOOGLE_MAPS_API_KEY = "AIzaSyAyFPqL4iu58iSmFKyko6mCo3kzvrf3nwM";

        // Gemini API Key: https://ai.google.dev/
        const GEMINI_API_KEY = "AIzaSyBFbuyZmbQvfCCM3sSt6ZlG5WUqVO8yXas";

        const DB_NAME = 'scriptsDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'scripts';

        let db;
        let chatHistory = [];
        let individualChatHistory = [];
        let mapScriptLoaded = false;

        // UI Elements
        const appContent = document.getElementById('app-content');
        const scriptsList = document.getElementById('scripts-list');
        const scriptForm = document.getElementById('script-form');
        const scriptTitle = document.getElementById('script-title');
        const scriptCategory = document.getElementById('script-category');
        const scriptContent = document.getElementById('script-content');
        const scriptId = document.getElementById('script-id');
        const saveScriptBtn = document.getElementById('save-script-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const statusMessage = document.getElementById('status-message');
        const statusText = document.getElementById('status-text');
        const successMessage = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        const loadingSpinnerOverlay = document.getElementById('loading-spinner-overlay');
        const loadingText = document.getElementById('loading-text');

        // Modal Elements (Script View)
        const scriptModal = document.getElementById('script-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalMediaContainer = document.getElementById('modal-media-container');
        const modalImages = document.getElementById('modal-images');
        const modalVideoContainer = document.getElementById('modal-video-container');
        const modalVideo = document.getElementById('modal-video');
        const locationDisplayContainer = document.getElementById('location-display-container');
        const modalLocationText = document.getElementById('modal-location-text');
        const mapContainer = document.getElementById('map-container');
        const closeModalBtn = document.getElementById('close-modal');

        // Global AI Modal Elements
        const globalAiModal = document.getElementById('global-ai-modal');
        const globalAiModalTitle = document.getElementById('global-ai-modal-title');
        const closeGlobalAiModalBtn = document.getElementById('close-global-ai-modal');
        const summarizeAllBtn = document.getElementById('summarize-all-btn');
        const chatAllBtn = document.getElementById('chat-all-btn');
        const searchAllBtn = document.getElementById('search-all-btn');
        const globalSummaryOutput = document.getElementById('global-summary-output');
        const globalChatContainer = document.getElementById('global-chat-container');
        const globalChatMessages = document.getElementById('global-chat-messages');
        const globalChatInput = document.getElementById('global-chat-input');
        const globalChatSendBtn = document.getElementById('global-chat-send');
        const globalSearchContainer = document.getElementById('global-search-container');
        const globalSearchInput = document.getElementById('global-search-input');
        const globalSearchResults = document.getElementById('global-search-results');
        const globalSearchSendBtn = document.getElementById('global-search-send-btn');
        const loadingSpinnerModal = document.getElementById('loading-spinner-modal');
        const modalStatusMessage = document.getElementById('modal-status-message');
        const modalStatusText = document.getElementById('modal-status-text');

        // Individual Chat Modal Elements
        const individualChatModal = document.getElementById('individual-chat-modal');
        const individualChatTitle = document.getElementById('individual-chat-title');
        const closeIndividualChatBtn = document.getElementById('close-individual-chat');
        const individualChatMessages = document.getElementById('individual-chat-messages');
        const individualChatInput = document.getElementById('individual-chat-input');
        const individualChatSendBtn = document.getElementById('individual-chat-send');

        // Global Action Elements
        const mainSearchInput = document.getElementById('main-search-input');
        const filterCategory = document.getElementById('filter-category');
        const sortMenu = document.getElementById('sort-menu');
        const exportAllBtn = document.getElementById('export-all-btn');
        const importFile = document.getElementById('import-file');

        // Geolocation Elements
        const getLocationBtn = document.getElementById('get-location-btn');
        const scriptAddress = document.getElementById('script-address');
        const searchAddressBtn = document.getElementById('search-address-btn');
        const locationStatus = document.getElementById('location-status');
        const scriptLocationCoords = document.getElementById('script-location-coords');
        const scriptLocationAddress = document.getElementById('script-location-address');

        // Multimedia Elements
        const imageUpload = document.getElementById('image-upload');
        const videoUpload = document.getElementById('video-upload');
        const imagePreviews = document.getElementById('image-previews');
        const fileStatus = document.getElementById('file-status');
        const scriptImages = document.getElementById('script-images');
        const scriptVideo = document.getElementById('script-video');
        let uploadedImages = [];
        let uploadedVideo = null;

        // Speech Recognition
        const voiceToTextBtn = document.getElementById('voice-to-text-btn');
        const voiceStatus = document.getElementById('voice-status');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        // --- Core Functions ---

        function showLoading(text) {
            loadingText.textContent = text;
            loadingSpinnerOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinnerOverlay.classList.add('hidden');
        }

        function showStatus(text, type = 'error') {
            if (type === 'error') {
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('bg-green-100', 'text-green-700', 'border-green-500');
                statusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-500');
                statusMessage.querySelector('p').textContent = 'Error del Sistema';
                statusText.textContent = text;
            } else if (type === 'success') {
                successMessage.classList.remove('hidden');
                successText.textContent = text;
            }
            setTimeout(() => {
                statusMessage.classList.add('hidden');
                successMessage.classList.add('hidden');
            }, 5000);
        }

        function showModalStatus(text, type = 'error') {
            modalStatusMessage.classList.remove('hidden');
            if (type === 'error') {
                modalStatusMessage.classList.remove('bg-green-100', 'text-green-700', 'border-green-500');
                modalStatusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-500');
            } else {
                modalStatusMessage.classList.remove('bg-red-100', 'text-red-700', 'border-red-500');
                modalStatusMessage.classList.add('bg-green-100', 'text-green-700', 'border-green-500');
            }
            modalStatusText.textContent = text;
        }

        function hideModalStatus() {
            modalStatusMessage.classList.add('hidden');
        }

        function showLoadingModal() {
            loadingSpinnerModal.classList.remove('hidden');
        }

        function hideLoadingModal() {
            loadingSpinnerModal.classList.add('hidden');
        }

        // --- IndexedDB Functions ---

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('title', 'title', { unique: false });
                        objectStore.createIndex('category', 'category', { unique: false });
                        objectStore.createIndex('createdAt', 'createdAt', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject('Error al abrir la base de datos.');
                };
            });
        }

        function addScript(script) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(script);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function updateScript(script) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(script);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function deleteScript(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getScripts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function getScriptById(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);

                request.onsuccess = () => {
                    if (request.result) {
                        resolve(request.result);
                    } else {
                        reject('Script not found');
                    }
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // --- UI Rendering and Handlers ---

        function displayScripts(scripts) {
            scriptsList.innerHTML = '';
            if (scripts.length === 0) {
                scriptsList.innerHTML = `<p class="text-center text-gray-500">No hay guiones guardados. ¬°Empieza a escribir uno!</p>`;
                return;
            }

            scripts.forEach(script => {
                const scriptCard = document.createElement('div');
                scriptCard.id = `script-${script.id}`;
                scriptCard.className = 'bg-white p-6 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-center transition-transform hover:scale-[1.01]';
                
                const cardContent = document.createElement('div');
                cardContent.className = 'flex-grow mb-4 sm:mb-0';
                cardContent.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800">${script.title}</h3>
                    <p class="text-sm text-gray-500 mb-2">${getCategoryName(script.category)}</p>
                    <p class="text-gray-600 line-clamp-3">${script.content}</p>
                `;

                const cardButtons = document.createElement('div');
                cardButtons.className = 'flex space-x-2 mt-4 sm:mt-0 script-card-buttons';
                
                const viewBtn = createButton('Ver', 'view-btn', 'bg-blue-500', 'fas fa-eye', 'Ver Gui√≥n');
                const editBtn = createButton('Editar', 'edit-btn', 'bg-yellow-500', 'fas fa-edit', 'Editar Gui√≥n');
                const deleteBtn = createButton('Eliminar', 'delete-btn', 'bg-red-500', 'fas fa-trash-alt', 'Eliminar Gui√≥n');
                
                cardButtons.appendChild(viewBtn);
                cardButtons.appendChild(editBtn);
                cardButtons.appendChild(deleteBtn);

                viewBtn.addEventListener('click', () => viewScript(script));
                editBtn.addEventListener('click', () => editScript(script));
                deleteBtn.addEventListener('click', () => deleteScriptFromUI(script.id));

                scriptCard.appendChild(cardContent);
                scriptCard.appendChild(cardButtons);
                scriptsList.appendChild(scriptCard);
            });
        }

        function createButton(text, className, bgColor, iconClass, title) {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = `text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-1 ${bgColor} ${className}`;
            button.title = title;
            const icon = document.createElement('i');
            icon.className = iconClass;
            button.prepend(icon);
            return button;
        }

        async function refreshScriptsList() {
            try {
                let scripts = await getScripts();
                const searchTerm = mainSearchInput.value.toLowerCase();
                const filterValue = filterCategory.value;
                const sortValue = sortMenu.value;

                // Filter
                if (filterValue !== 'all') {
                    scripts = scripts.filter(s => s.category === filterValue);
                }
                
                // Search
                if (searchTerm) {
                    scripts = scripts.filter(s =>
                        s.title.toLowerCase().includes(searchTerm) ||
                        s.content.toLowerCase().includes(searchTerm)
                    );
                }

                // Sort
                if (sortValue === 'recent') {
                    scripts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                } else if (sortValue === 'oldest') {
                    scripts.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                }

                displayScripts(scripts);
            } catch (error) {
                showStatus('Error al cargar los guiones: ' + error);
            }
        }

        function resetForm() {
            scriptForm.reset();
            scriptId.value = '';
            saveScriptBtn.textContent = 'Guardar Gui√≥n';
            cancelEditBtn.classList.add('hidden');
            scriptLocationCoords.value = '';
            scriptLocationAddress.value = '';
            locationStatus.textContent = '';
            imagePreviews.innerHTML = '';
            fileStatus.textContent = '';
            uploadedImages = [];
            uploadedVideo = null;
        }
        
        function editScript(script) {
            scriptId.value = script.id;
            scriptTitle.value = script.title;
            scriptCategory.value = script.category;
            scriptContent.value = script.content;
            
            uploadedImages = script.images || [];
            uploadedVideo = script.video || null;
            
            imagePreviews.innerHTML = '';
            if (uploadedImages.length > 0) {
                uploadedImages.forEach(base64 => {
                    const img = document.createElement('img');
                    img.src = base64;
                    img.className = 'image-preview';
                    imagePreviews.appendChild(img);
                });
            }
            
            if (uploadedVideo) {
                fileStatus.textContent = 'Video cargado.';
            } else {
                fileStatus.textContent = '';
            }

            if (script.location) {
                scriptLocationCoords.value = script.location.coords;
                scriptLocationAddress.value = script.location.address;
                locationStatus.textContent = `Ubicaci√≥n guardada: ${script.location.address}`;
            } else {
                scriptLocationCoords.value = '';
                scriptLocationAddress.value = '';
                locationStatus.textContent = '';
            }

            saveScriptBtn.textContent = 'Actualizar Gui√≥n';
            cancelEditBtn.classList.remove('hidden');
        }

        async function deleteScriptFromUI(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este gui√≥n?')) {
                try {
                    await deleteScript(id);
                    showStatus('Gui√≥n eliminado exitosamente.', 'success');
                    refreshScriptsList();
                } catch (error) {
                    showStatus('Error al eliminar el gui√≥n: ' + error);
                }
            }
        }

        function getCategoryName(value) {
            const options = Array.from(scriptCategory.options);
            const option = options.find(opt => opt.value === value);
            return option ? option.textContent : 'Sin categor√≠a';
        }

        // --- Modals ---

        function loadGoogleMapsScript(callback, scriptData) {
            if (mapScriptLoaded) {
                callback(scriptData);
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
            document.head.appendChild(script);
            mapScriptLoaded = true;

            // Define the global callback
            window.initMap = () => callback(scriptData);
        }

        function initModalMap(script) {
            if (script.location && script.location.coords && GOOGLE_MAPS_API_KEY !== "TU_API_KEY_DE_GOOGLE_MAPS_AQU√ç") {
                const [lat, lon] = script.location.coords.split(',').map(Number);
                const map = new google.maps.Map(mapContainer, {
                    center: { lat, lng: lon },
                    zoom: 12,
                });
                new google.maps.Marker({
                    position: { lat, lng: lon },
                    map,
                    title: script.title,
                });
            } else {
                 mapContainer.innerHTML = '<p class="text-center text-gray-500">No se pudo cargar el mapa. Verifica que la clave de Google Maps sea v√°lida y que haya una ubicaci√≥n guardada.</p>';
            }
        }
        
        function viewScript(script) {
            modalTitle.textContent = script.title;
            modalContent.value = script.content;

            // Media
            modalMediaContainer.classList.add('hidden');
            modalImages.innerHTML = '';
            modalVideoContainer.classList.add('hidden');
            modalVideo.src = '';
            
            if (script.images && script.images.length > 0) {
                modalMediaContainer.classList.remove('hidden');
                script.images.forEach(base64 => {
                    const img = document.createElement('img');
                    img.src = base64;
                    img.className = 'image-preview';
                    modalImages.appendChild(img);
                });
            }

            if (script.video) {
                modalMediaContainer.classList.remove('hidden');
                modalVideoContainer.classList.remove('hidden');
                modalVideo.src = script.video;
            }

            // Location
            locationDisplayContainer.classList.add('hidden');
            if (script.location) {
                locationDisplayContainer.classList.remove('hidden');
                modalLocationText.textContent = `Direcci√≥n: ${script.location.address}`;
                if (script.location.coords) {
                    loadGoogleMapsScript(initModalMap, script);
                }
            } else {
                modalLocationText.textContent = 'No se guard√≥ una ubicaci√≥n para este guion.';
            }

            scriptModal.classList.remove('hidden');
            scriptModal.dataset.scriptId = script.id;
        }

        // --- Event Listeners ---

        window.addEventListener('load', async () => {
            try {
                showLoading('Iniciando la aplicaci√≥n...');
                await openDatabase();
                await refreshScriptsList();
                appContent.classList.remove('hidden');
                hideLoading();
            } catch (error) {
                showStatus('La aplicaci√≥n no pudo iniciarse correctamente: ' + error);
                hideLoading();
            }
        });

        scriptForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const title = scriptTitle.value;
            const category = scriptCategory.value;
            const content = scriptContent.value;
            const id = scriptId.value ? parseInt(scriptId.value) : null;

            const script = {
                title,
                category,
                content,
                createdAt: new Date().toISOString(),
                images: uploadedImages,
                video: uploadedVideo,
            };

            if (scriptLocationCoords.value) {
                script.location = {
                    coords: scriptLocationCoords.value,
                    address: scriptLocationAddress.value,
                };
            }

            try {
                if (id) {
                    // Si el guion tiene un ID, se actualiza
                    script.id = id;
                    await updateScript(script);
                    showStatus('Guion actualizado exitosamente.', 'success');
                } else {
                    // Si es un guion nuevo, se a√±ade sin ID para que IndexedDB lo asigne
                    await addScript(script);
                    showStatus('Guion guardado exitosamente.', 'success');
                }
                resetForm();
                refreshScriptsList();
            } catch (error) {
                showStatus('Error al guardar el guion: ' + error.message, 'error');
                console.error('Error al guardar el guion:', error);
            }
        });

        cancelEditBtn.addEventListener('click', resetForm);

        closeModalBtn.addEventListener('click', () => {
            scriptModal.classList.add('hidden');
        });

        closeGlobalAiModalBtn.addEventListener('click', () => {
            globalAiModal.classList.add('hidden');
            globalChatMessages.innerHTML = '';
            globalSearchResults.innerHTML = '';
            globalChatContainer.classList.add('hidden');
            globalSummaryOutput.classList.add('hidden');
            globalSearchContainer.classList.add('hidden');
            chatHistory = [];
        });

        closeIndividualChatBtn.addEventListener('click', () => {
            individualChatModal.classList.add('hidden');
            individualChatMessages.innerHTML = '';
            individualChatHistory = [];
        });
        
        scriptsList.addEventListener('click', async (event) => {
            const target = event.target.closest('.edit-btn');
            if (target) {
                const id = parseInt(target.closest('[id^="script-"]').id.replace('script-', ''));
                try {
                    const script = await getScriptById(id);
                    editScript(script);
                } catch (error) {
                    showStatus('No se pudo cargar el gui√≥n para editar: ' + error);
                }
            }
        });
        
        mainSearchInput.addEventListener('input', refreshScriptsList);
        filterCategory.addEventListener('change', refreshScriptsList);
        sortMenu.addEventListener('change', refreshScriptsList);

        // --- Geolocation and Address Search ---

        getLocationBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                locationStatus.textContent = 'Obteniendo ubicaci√≥n...';
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        scriptLocationCoords.value = `${lat},${lon}`;
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                            const data = await response.json();
                            const address = data.display_name || 'Direcci√≥n no encontrada';
                            scriptLocationAddress.value = address;
                            locationStatus.textContent = `Ubicaci√≥n obtenida: ${address}`;
                        } catch (error) {
                            console.error('Error al obtener la direcci√≥n:', error);
                            locationStatus.textContent = `Ubicaci√≥n obtenida: ${lat}, ${lon} (No se pudo resolver la direcci√≥n)`;
                        }
                    },
                    (error) => {
                        console.error('Error de geolocalizaci√≥n:', error);
                        locationStatus.textContent = 'No se pudo obtener la ubicaci√≥n.';
                    }
                );
            } else {
                locationStatus.textContent = 'La geolocalizaci√≥n no est√° soportada por tu navegador.';
            }
        });

        searchAddressBtn.addEventListener('click', async () => {
            const addressQuery = scriptAddress.value;
            if (addressQuery) {
                locationStatus.textContent = 'Buscando direcci√≥n...';
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addressQuery)}&format=json&limit=1`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        scriptLocationCoords.value = `${lat},${lon}`;
                        scriptLocationAddress.value = result.display_name;
                        locationStatus.textContent = `Direcci√≥n encontrada: ${result.display_name}`;
                    } else {
                        locationStatus.textContent = 'No se encontr√≥ la direcci√≥n. Intenta con otra b√∫squeda.';
                        scriptLocationCoords.value = '';
                        scriptLocationAddress.value = '';
                    }
                } catch (error) {
                    console.error('Error al buscar la direcci√≥n:', error);
                    locationStatus.textContent = 'Error al buscar la direcci√≥n. Int√©ntalo de nuevo.';
                }
            } else {
                locationStatus.textContent = 'Por favor, ingresa una direcci√≥n para buscar.';
            }
        });

        // --- Multimedia Handlers ---

        imageUpload.addEventListener('change', (event) => {
            uploadedImages = [];
            imagePreviews.innerHTML = '';
            const files = event.target.files;
            if (files.length > 0) {
                fileStatus.textContent = `Cargando ${files.length} imagen(es)...`;
                let filesProcessed = 0;
                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-preview';
                        imagePreviews.appendChild(img);
                        uploadedImages.push(e.target.result);
                        filesProcessed++;
                        if (filesProcessed === files.length) {
                            fileStatus.textContent = `${files.length} imagen(es) cargada(s).`;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            } else {
                fileStatus.textContent = '';
            }
        });

        videoUpload.addEventListener('change', (event) => {
            uploadedVideo = null;
            const file = event.target.files[0];
            if (file) {
                fileStatus.textContent = 'Cargando video...';
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedVideo = e.target.result;
                    fileStatus.textContent = 'Video cargado.';
                };
                reader.readAsDataURL(file);
            } else {
                fileStatus.textContent = '';
            }
        });

        // --- API & AI Functions ---

        async function getModelResponse(prompt, history = [], isGlobalSearch = false) {
            if (GEMINI_API_KEY === "TU_API_KEY_DE_GEMINI_AQU√ç" || !GEMINI_API_KEY) {
                throw new Error('API_KEY de Gemini no configurada. Reemplaza "TU_API_KEY_DE_GEMINI_AQU√ç" con tu clave real.');
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const parts = [{ text: prompt }];

            const requestBody = {
                contents: [
                    ...history,
                    { role: "user", parts }
                ]
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('API Error:', errorData);
                throw new Error(`Error de la API: ${response.status} - ${errorData.error.message}`);
            }

            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Respuesta de la API inesperada.');
            }
        }

        async function summarizeAllScripts() {
            showLoadingModal();
            try {
                const scripts = await getScripts();
                if (scripts.length === 0) {
                    showModalStatus('No hay guiones para resumir.', 'error');
                    hideLoadingModal();
                    return;
                }
                const combinedContent = scripts.map(s => `T√≠tulo: ${s.title}\nContenido: ${s.content}`).join('\n\n---\n\n');
                const prompt = `Act√∫a como un analista de historias profesional. Analiza y resume la siguiente colecci√≥n de guiones. Identifica temas recurrentes, la diversidad de categor√≠as y cualquier otro patr√≥n interesante. Formatea tu respuesta con t√≠tulos y vi√±etas para que sea f√°cil de leer.\n\nGuiones:\n${combinedContent}`;
                const summary = await getModelResponse(prompt);
                globalSummaryOutput.innerHTML = marked.parse(summary);
                globalSummaryOutput.classList.remove('hidden');
                globalChatContainer.classList.add('hidden');
                globalSearchContainer.classList.add('hidden');
            } catch (error) {
                showModalStatus('Error al generar el resumen: ' + error.message, 'error');
            } finally {
                hideLoadingModal();
            }
        }

        async function chatWithAllScripts() {
            globalChatMessages.innerHTML = '';
            globalChatContainer.classList.remove('hidden');
            globalSummaryOutput.classList.add('hidden');
            globalSearchContainer.classList.add('hidden');
            
            showLoadingModal();
            try {
                const scripts = await getScripts();
                const combinedContent = scripts.map(s => `T√≠tulo: ${s.title}\nContenido: ${s.content}`).join('\n\n---\n\n');
                const systemPrompt = `Act√∫a como un asistente de IA experto en guiones. Tienes acceso a la siguiente colecci√≥n de guiones. Responde preguntas sobre ellos, compara guiones, identifica patrones o elabora sobre temas espec√≠ficos bas√°ndote solo en la informaci√≥n proporcionada. S√© conciso y √∫til.\n\nColecci√≥n de Guiones:\n${combinedContent}\n\n`;
                chatHistory.push({ role: "user", parts: [{ text: systemPrompt }] });
                const greeting = await getModelResponse('Hola, ¬øqu√© puedes hacer con esta colecci√≥n?', chatHistory);
                addMessageToChat('gemini', greeting, globalChatMessages);
                hideLoadingModal();
            } catch (error) {
                showModalStatus('Error al iniciar el chat: ' + error.message, 'error');
                hideLoadingModal();
            }
        }

        async function searchWithWeb() {
            globalSearchResults.innerHTML = '';
            globalSearchContainer.classList.remove('hidden');
            globalSummaryOutput.classList.add('hidden');
            globalChatContainer.classList.add('hidden');
        }

        async function chatWithIndividualScript(script) {
            individualChatMessages.innerHTML = '';
            individualChatModal.classList.remove('hidden');
            individualChatTitle.textContent = `Chat con: ${script.title}`;
            
            showLoadingModal();
            try {
                const systemPrompt = `Act√∫a como un asistente de IA experto en guiones. Tienes acceso al siguiente guion. Responde preguntas sobre √©l, analiza su estructura, personajes, y temas. S√© conciso y √∫til.\n\nGuion:\n${script.content}\n\n`;
                individualChatHistory.push({ role: "user", parts: [{ text: systemPrompt }] });
                const greeting = await getModelResponse('Hola, ¬øpuedes resumir este guion para m√≠?', individualChatHistory);
                addMessageToChat('gemini', greeting, individualChatMessages);
                hideLoadingModal();
            } catch (error) {
                showModalStatus('Error al iniciar el chat: ' + error.message, 'error');
                hideLoadingModal();
            }
        }

        function addMessageToChat(role, text, container) {
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'chat-user-bubble' : 'chat-gemini-bubble';
            messageDiv.innerHTML = marked.parse(text);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        globalChatSendBtn.addEventListener('click', async () => {
            const userMessage = globalChatInput.value.trim();
            if (!userMessage) return;

            addMessageToChat('user', userMessage, globalChatMessages);
            globalChatInput.value = '';
            showLoadingModal();

            try {
                chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                const geminiResponse = await getModelResponse(userMessage, chatHistory);
                chatHistory.push({ role: "model", parts: [{ text: geminiResponse }] });
                addMessageToChat('gemini', geminiResponse, globalChatMessages);
            } catch (error) {
                showModalStatus('Error en la respuesta de la IA. Por favor, intenta de nuevo.', 'error');
                console.error('Chat error:', error);
            } finally {
                hideLoadingModal();
            }
        });

        globalSearchSendBtn.addEventListener('click', async () => {
            const userQuery = globalSearchInput.value.trim();
            if (!userQuery) return;

            globalSearchResults.innerHTML = '';
            showLoadingModal();
            try {
                const prompt = `Busca informaci√≥n en la web sobre "${userQuery}" y resume los hallazgos en espa√±ol.`;
                const searchResponse = await getModelResponse(prompt, [], true);
                addMessageToChat('gemini', searchResponse, globalSearchResults);
            } catch (error) {
                showModalStatus('Error al realizar la b√∫squeda: ' + error.message, 'error');
            } finally {
                hideLoadingModal();
            }
        });

        individualChatSendBtn.addEventListener('click', async () => {
            const userMessage = individualChatInput.value.trim();
            if (!userMessage) return;
            
            addMessageToChat('user', userMessage, individualChatMessages);
            individualChatInput.value = '';
            showLoadingModal();
            
            try {
                individualChatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                const geminiResponse = await getModelResponse(userMessage, individualChatHistory);
                individualChatHistory.push({ role: "model", parts: [{ text: geminiResponse }] });
                addMessageToChat('gemini', geminiResponse, individualChatMessages);
            } catch (error) {
                showModalStatus('Error en la respuesta de la IA. Por favor, intenta de nuevo.', 'error');
                console.error('Individual chat error:', error);
            } finally {
                hideLoadingModal();
            }
        });

        // --- Export/Import ---

        exportAllBtn.addEventListener('click', async () => {
            try {
                const scripts = await getScripts();
                const dataStr = JSON.stringify(scripts, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'guiones_exportados.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showStatus('Todos los guiones han sido exportados.', 'success');
            } catch (error) {
                showStatus('Error al exportar los guiones: ' + error.message, 'error');
            }
        });

        importFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const scripts = JSON.parse(e.target.result);
                    for (const script of scripts) {
                        delete script.id; // Remove old ID to let IndexedDB create a new one
                        await addScript(script);
                    }
                    showStatus(`${scripts.length} guiones importados exitosamente.`, 'success');
                    refreshScriptsList();
                } catch (error) {
                    showStatus('Error al importar el archivo. Aseg√∫rate de que es un archivo JSON v√°lido.', 'error');
                }
            };
            reader.readAsText(file);
        });

        // --- Voice-to-Text ---

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.interimResults = true;

            let isRecognizing = false;

            voiceToTextBtn.addEventListener('click', () => {
                if (isRecognizing) {
                    recognition.stop();
                    return;
                }

                voiceStatus.textContent = 'Escuchando... Di algo.';
                voiceStatus.classList.remove('hidden');
                voiceToTextBtn.classList.add('voice-active');
                
                recognition.start();
                isRecognizing = true;
            });

            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                scriptContent.value = transcript;
            };

            recognition.onend = () => {
                voiceStatus.textContent = '';
                voiceStatus.classList.add('hidden');
                voiceToTextBtn.classList.remove('voice-active');
                isRecognizing = false;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                voiceStatus.textContent = `Error: ${event.error}. Intenta de nuevo.`;
                voiceToTextBtn.classList.remove('voice-active');
                isRecognizing = false;
            };
        } else {
            voiceToTextBtn.disabled = true;
            voiceToTextBtn.title = 'Reconocimiento de voz no soportado en este navegador';
            voiceToTextBtn.style.cursor = 'not-allowed';
        }
    </script>
</body>
</html>
